{% extends 'portfolio/base.html' %}
{% block title %}Moje Portfolio{% endblock %}
{% block content %}
<h1 class="display-4">
  {% if is_owner %}Moje Portfolio{% else %}Portfolio użytkownika {{ portfolio.user.username }}{% endif %}
</h1>
<div class="card mb-4">
    <div class="card-body">
        <h3>
  {% if filters_active %}
    Wartość (po filtrach): <span class="text-success">{{ total_value|floatformat:2 }} zł</span>
    <div class="text-muted small mt-1">
      Wartość całego portfolio: {{ portfolio_total_value|floatformat:2 }} zł
    </div>
  {% else %}
    Całkowita wartość kolekcji: <span class="text-success">{{ total_value|floatformat:2 }} zł</span>
  {% endif %}
</h3>
        <p>Liczba kart: {{ cards.count }}</p>
    </div>
</div>
<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-md-4">
    <label class="form-label">Set</label>
    <select name="set" class="form-select">
      <option value="">Wszystkie</option>
      {% for s in sets %}
        <option value="{{ s.id }}" {% if selected_set == s.id|stringformat:"s" %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-4">
    <label class="form-label">Stan</label>
    <select name="condition" class="form-select">
      <option value="">Wszystkie</option>
      {% for key,label in conditions %}
        <option value="{{ key }}" {% if selected_condition == key %}selected{% endif %}>
          {{ label }}
        </option>
      {% endfor %}
    </select>
  </div>

  <div class="col-md-4 d-flex gap-2">
    <button class="btn btn-primary" type="submit">Filtruj</button>
    <a class="btn btn-outline-secondary" href="{{ request.path }}">Wyczyść</a>
  </div>
  <div class="col-md-4">
  <label class="form-label">Sortuj</label>
  <select name="sort" class="form-select">
    <option value="date_desc" {% if sort == "date_desc" %}selected{% endif %}>Data dodania (najnowsze)</option>
    <option value="date_asc"  {% if sort == "date_asc" %}selected{% endif %}>Data dodania (najstarsze)</option>

    <option value="price_desc" {% if sort == "price_desc" %}selected{% endif %}>Cena (malejąco)</option>
    <option value="price_asc"  {% if sort == "price_asc" %}selected{% endif %}>Cena (rosnąco)</option>

    <option value="name_asc" {% if sort == "name_asc" %}selected{% endif %}>Nazwa (A→Z)</option>
    <option value="name_desc" {% if sort == "name_desc" %}selected{% endif %}>Nazwa (Z→A)</option>

    <option value="set_asc" {% if sort == "set_asc" %}selected{% endif %}>Set (A→Z)</option>
    <option value="set_desc" {% if sort == "set_desc" %}selected{% endif %}>Set (Z→A)</option>
  </select>
</div>
</form>
{% if is_owner %}
  <div class="d-flex justify-content-end mb-3">
    <a class="btn btn-primary" href="{% url 'card_add' %}">➕ Dodaj kartę</a>
  </div>
{% endif %}
{% if cards %}
<div class="card shadow-sm">
  <div class="card-body">
    <div class="table-responsive">
          <table class="table table-striped table-hover table-bordered align-middle text-center">
            <thead class="table-light">
                <tr>
                    <th>Zdjęcie</th>
                    <th>Nazwa</th>
                    <th>Set</th>
                    <th>Numer</th>
                    <th>Stan</th>
                    <th>Cena</th>
                    <th>Data dodania</th>
                    {% if is_owner %}<th>Akcje</th>{% endif %}
             
                </tr>
            </thead>
            <tbody>
                {% for card_instance in cards %}
                <tr>
                 <td class="align-middle" style="width: 180px;">
  {% if card_instance.image %}
    <a href="{{ card_instance.image.url }}" target="_blank" rel="noopener">
      <img
        src="{{ card_instance.image.url }}"
        alt="zdjęcie karty"
        class="img-thumbnail"
        style="height:160px; width:160px; object-fit:contain;"
      >
    </a>
  {% else %}
    —
  {% endif %}
</td>
                    <td>{{ card_instance.card.name }}</td>
                    <td>{{ card_instance.card.card_set.name }}</td>
                    <td>{{ card_instance.card.card_number }}</td>
                    <td>{{ card_instance.get_condition_display }}</td>
                    <td>{{ card_instance.price|floatformat:2 }} zł</td>
                    <td>{{ card_instance.added_at|date:"Y-m-d" }}</td>
                  {% if is_owner %}
<td>
  <a class="btn btn-sm btn-outline-secondary" href="{% url 'card_edit' card_instance.pk %}">Edytuj</a>
  <a class="btn btn-sm btn-outline-danger" href="{% url 'card_delete' card_instance.pk %}">Usuń</a>
</td>
{% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    </div>
</div>
{% else %}
    <div class="alert alert-info">
        <p>Nie masz jeszcze żadnych kart w portfolio.</p>
    </div>
{% endif %}
{% endblock %}